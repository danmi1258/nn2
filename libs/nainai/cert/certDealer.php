<?php
/**
 * 交易商认证管理类
 * author: weipinglee
 * Date: 2016/4/27 0027
 * Time: 下午 3:35
 */

namespace nainai\cert;
use \Library\M;
use \Library\Time;
use \Library\Query;
use \Library\Thumb;
use \Library\log;
use \Library\JSON;
class certDealer extends certificate{


    protected static $certType = 'deal';
    //认证需要的字段,0个人用户，1企业用户
    protected static $certFields = array(

        0=>array(
            'true_name',
            'identify_no',
            'identify_front',
            'identify_back'
        ),
        1=>array(
            'company_name',
            'area',
            'address',
            'legal_person',
            'contact',
            'contact_phone',
            'cert_oc',//组织机构代码证
            'cert_bl',
            'cert_tax'
        )
    );

    /**
     * 验证规则：
     * array(字段，规则，错误信息，条件，附加规则，时间）
     * 条件：0：存在字段则验证 1：必须验证 2：不为空时验证
     *
     */
    private $rules = array(
        array('user_id','number','用户id错误'),//默认是正则
    );



    /**
     *获取认证资料
     * @param $user_id
     */
    public function getCertData($user_id){
        return $this->getCertDetail($user_id,self::$certType);


    }



    /**
     * 认证交易商
     * @param array  $accData 账户数据（个人、公司表数据）
     * @param array $certData 认证数据 （认证表的数据）
     */
    public function certDealApply($accData,$certData=array()){

        //检验公司个人信息是否符合规则
        $m = new \UserModel();
        if($this->user_type==1){
           $check = $m->checkCompanyInfo($accData);
        }
        else
            $check = $m->checkPersonInfo($accData);


        $certObj = new M(self::$certClass[self::$certType]);


        if($check===true ){
            //检验其他的认证是否需要重新认证
            $reCertType = $this->checkOtherCert($accData);
            $certObj->beginTrans();
            if(!empty($reCertType))//若果重新认证的类型不为空，对其初始化
                $this->certInit($reCertType);

            $this->createCertApply(self::$certType,$accData,$certData);

            $res = $certObj->commit();
        }
        else{
            $res = $check;
        }

        if($res===true){
            echo  JSON::encode(\Library\Tool::getSuccInfo());
            exit;
        }

        else{
            echo \Library\Tool::getSuccInfo(0,is_string($res) ? $res : '申请失败');
            exit;
        }

    }

    //获取交易商认证列表
    public function certList($page){
       return parent::certApplyList(self::$certType,$page);
    }


}